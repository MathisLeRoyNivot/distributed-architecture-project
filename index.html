<html>

<head>
    <meta charset="utf-8">
    <title>poc</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4.4/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.4.4/leaflet.js"></script>
</head>

<body>
    <div id="map"></div>

    <script>
        let populationData = null;
        let fastfoodData = null;
        let geoData = null;
        
        const colorGradient = fadeFraction => {
            const color1 = {red: 0, green: 0, blue: 255}
            const color2 = {red: 255, green: 0, blue:0}
            const fade = fadeFraction;

            const diffRed = color2.red - color1.red;
            const diffGreen = color2.green - color1.green;
            const diffBlue = color2.blue - color1.blue;

            const gradient = {
                red: parseInt(Math.floor(color1.red + (diffRed * fade)), 10),
                green: parseInt(Math.floor(color1.green + (diffGreen * fade)), 10),
                blue: parseInt(Math.floor(color1.blue + (diffBlue * fade)), 10),
            };

            return `rgb(${gradient.red}, ${gradient.green}, ${gradient.blue})`;
        }

        const loadMap = () => {

            console.log(geoData);
            // console.log(populationData);
            // console.log(fastfoodData);

            const data = [];
            // fastfoodData.forEach((ffRawData, i) => {
            //     const cols = ffRawData.split(",");
            //     console.log(cols)
            // });

            let min;
            let max;

            populationData.forEach((data, i) => {
                if (!i) return;
                const [code, name, population, fastfood] = data.split(",");
                const n = fastfood / population;
                if (min === undefined || n < min) min = n;
                if (max === undefined || n > max) max = n;
            });

            console.log(min, max)

            populationData.forEach((data, i) => {
                if (!i) return;
                const [code, name, population, fastfood] = data.split(",");
                const feature = geoData.features.find(feature => feature.properties.code === code);
                if (feature) {
                    const n = (fastfood / population - min) / (max - min);
                    // console.log(name, n);
                    feature.properties.fillColor = colorGradient(n);
                    feature.properties.fillOpacity = 1;
                    feature.properties.opacity = 1;
                    feature.properties.color = colorGradient(n)
                }
            });

            const map = L.map("map").setView([46.7111, 1.7191], 6); // Center of France

            const OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                minZoom: 3,
                maxZoom: 15,
            }).addTo(map);

            const data_lyr = L.geoJson(geoData, {
                // onEachFeature: (feature, featureLayer) => featureLayer.bindPopup(feature.properties.NAME_1),
                pointToLayer: (feature, latlng) => L.marker(latlng),
                style: feature => ({ 
                    fillColor: feature.properties.fillColor,
                    fillOpacity: 0.5,
                    color: feature.properties.fillColor,
                    opacity: 1,
                })
            }).addTo(map);
        }

        const loadJson = (path, callback) => {
            const xhr = new XMLHttpRequest();
            xhr.onreadystatechange = () => {
                if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status < 300) {
                    callback(JSON.parse(xhr.responseText));
                }
            }
            xhr.open("GET", path);
            xhr.send();
        }

        const loadFile = (path, callback) => {
            const xhr = new XMLHttpRequest();
            xhr.onreadystatechange = () => {
                if (xhr.readyState == 4 && xhr.status >= 200 && xhr.status < 300) {
                    callback(xhr.responseText.split(/\r\n/));
                }
            }
            xhr.open("GET", path);
            xhr.send();
            // function showData(data) {
            //     for (rowNum = 0; rowNum < rows.length; ++rowNum) {
            //         cells = rows[rowNum].split(",");
            //     }
            // }
        }
        loadFile("./part-00000-fbb11be9-7a58-4e83-b967-e6bbb70fcedf-c000.csv", resPop => {
            loadFile("./datacsv.csv/part-00000-4df33126-c631-4c31-b2f8-40d327863c7d-c000.csv", resFF => {
                loadJson("./departements.geojson", resJson => {
                    geoData = resJson;
                    populationData = resPop;
                    fastfoodData = resFF;
                    loadMap();
                });
            });
        });
    </script>

</body>

</html>