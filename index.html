<html>

<head>
    <meta charset="utf-8">
    <title>poc</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet-src.min.js"></script>
    <script src="./util.js"></script>
</head>

<body>
    <div id="map"></div>

    <script>
        const loadMap = (geoDATA, populationDATA, companyDATA) => {

            const density = {}

            // Heatmap colors
            let min, max;
            populationDATA.forEach(([code, name, population, count]) => {
                const n = count / population;
                    density[code] = Math.round(n * 100000);
                if (min === undefined || n < min) min = n;
                if (max === undefined || n > max) max = n;
            });
 
            populationDATA.forEach(([code, name, population, count]) => {
                const feature = geoDATA.features.find(feature => feature.properties.code === code);
                if (feature) {
                    const n = (count / population - min) / (max - min);
                    feature.properties.fillColor = colorGradient(n);
                }
            });

            // Leaflet map
            const map = L.map("map").setView([47, 0], 6);
            const OpenStreetMap_Mapnik = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                minZoom: 3,
                maxZoom: 15
            }).addTo(map);

            // Map popup
            const data_lyr = L.geoJson(geoDATA, {
                onEachFeature: (feature, layer) => {
                    const divElem = document.createElement("div");

                    const titleElem = document.createElement("h1");
                    titleElem.innerHTML = `${feature.properties.nom} (${feature.properties.code})<br>${density[feature.properties.code]} <span style="font-size:0.5em">pour 100K hab</span>`;
                    divElem.appendChild(titleElem);

                    const scrollElem = document.createElement("div");
                    scrollElem.style.height = "128px";
                    scrollElem.style.overflowY = "scroll";
                    divElem.appendChild(scrollElem);

                    const companies = companyDATA.filter(e => e[2].substring(0, 2) === feature.properties.code);
                    companies.forEach(([siret, name, code]) => {
                        const elem = document.createElement("p");
                        elem.style.margin = 0;
                        elem.innerHTML = name;
                        elem.title = siret;
                        elem.style.cursor = "help";
                        scrollElem.appendChild(elem);
                        scrollElem.appendChild(document.createElement("br"));
                    });

                    layer.bindPopup(divElem);
                },
                pointToLayer: (feature, latlng) => L.marker(latlng),
                style: feature => ({ fillColor: feature.properties.fillColor, weight: 2, opacity: 1, color: 'white', fillOpacity: 0.7 })
            }).addTo(map);
        }

        // Init
        loadFile("./fastFoodByDep.csv", populationDATA => {
            loadFile("./datacsv.csv/part-00000-4df33126-c631-4c31-b2f8-40d327863c7d-c000.csv", companyDATA => {
                loadFile("./departements.geojson", geoDATA => {
                    loadMap(
                        JSON.parse(geoDATA),
                        populationDATA.split(/\r\n/).map(e => e.split(",")).filter(e => e.length === 4 && !isNaN(e[0])),
                        companyDATA.split(/\r\n/).map(e => e.split(",")).filter(e => e.length === 3 && !isNaN(e[2])));
                });
            });
        });
    </script>

</body>

</html>